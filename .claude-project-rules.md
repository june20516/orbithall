# Orbithall 프로젝트 작업 지침

이 문서는 Claude가 Orbithall 프로젝트에서 작업할 때 따라야 할 규칙과 지침입니다.

## 핵심 원칙

### 1. 사람이 협업 가능한 코드만 작성
- **자동 생성 파일은 절대 직접 작성하지 않음**
  - `go.sum`: Go 명령어가 자동 생성
  - `package-lock.json`, `yarn.lock`: npm/yarn이 자동 생성
  - 기타 빌드 아티팩트, 캐시 파일 등
- 이유: 사람은 이런 파일을 직접 작성하지 않으며, 자동 생성되어야 함

### 2. 자동 생성 파일 처리 방법
- Dockerfile에서 선택적 복사 패턴 사용
  ```dockerfile
  COPY go.mod ./
  COPY go.su[m] ./ 2>/dev/null || true
  ```
- .gitignore에 자동 생성 파일 명시
- 사용자에게 명령어로 생성하도록 안내

### 3. 테스트 코드 작성 원칙
- **모든 구현에는 테스트 코드 작성**
  - 단위 테스트(unit test) 필수
  - 통합 테스트(integration test) 권장
- **테스트 작성이 불가능한 경우에만 생략**
  - 생략 시 이유를 코드 주석으로 명시
- **테스트 파일 위치**: `*_test.go` (Go 관례)
- **테스트 커버리지**: 핵심 로직 우선
- **테스트 원칙**:
  - Given-When-Then 패턴 사용
  - 테스트 이름은 명확하게 (TestFunctionName_Scenario_ExpectedResult)
  - 독립적 실행 가능 (테스트 간 의존성 없음)
  - 빠른 실행 (단위 테스트는 1초 이내)

## 기술 스택 및 도구

### Backend
- **언어**: Go 1.25
- **프레임워크**: Chi만 사용 (다른 프레임워크 제안 금지)
- **데이터베이스**: PostgreSQL 16

### 개발 환경
- **컨테이너화**: Docker 우선 (로컬 설치 최소화)
- **이유**: 다른 환경에 영향 최소화, 격리된 개발 환경
- Go, PostgreSQL 등은 로컬에 설치하지 않고 Docker로 실행

### 배포
- **플랫폼**: Render (API) + Supabase (Database)
- **프로덕션 URL**: https://orbithall.onrender.com

## 코드 작성 규칙

### 데이터베이스 관련 규칙

#### GetOrCreate 패턴
- **목적**: Race condition 방지 및 동시성 안전 보장
- **패턴**: ON CONFLICT DO NOTHING + 재조회
- **이유**: 빠른 요청이 동시에 들어올 때 unique constraint 위반 방지

**표준 구현 방법**:
```go
// 1단계: INSERT 시도 (충돌 시 무시)
_, err := db.Exec(`
    INSERT INTO table_name (unique_field, other_field)
    VALUES ($1, $2)
    ON CONFLICT (unique_field) DO NOTHING
`, uniqueValue, otherValue)

// 2단계: 반드시 재조회 (확실히 존재함을 보장)
row := db.QueryRow(`
    SELECT id, unique_field, other_field
    FROM table_name
    WHERE unique_field = $1
`, uniqueValue)
```

**잘못된 예시 (Race Condition 발생)**:
```go
// ❌ 조회 후 INSERT는 경합 조건 발생
result, _ := GetByKey(key)
if result == nil {
    // 이 사이에 다른 요청이 INSERT 할 수 있음!
    Insert(key, value)
}
```

**모든 GetOrCreate 메서드는 이 규칙을 따라야 함**

### 주석
- **대상**: Go를 모르는 사람도 이해할 수 있을 정도로 상세하게
- **스타일**: 간결하고 명확한 표현
- **금지**: 이모지, 과도한 장식
- **Self-contained 원칙**: 처음 보는 사람을 기준으로 작성
  - 변경 이력이나 과거 상태는 주석에 남기지 않음
  - "기존 X를 Y로 변경함" 같은 표현 금지
  - 현재 상태와 이유만 설명
- **좋은 예시**:
  ```go
  // Chi 라우터 생성
  // Chi는 가볍고 빠른 HTTP 라우터 라이브러리
  r := chi.NewRouter()

  // go.sum은 go mod download 실행 시 자동 생성됨
  COPY go.mod ./
  ```
- **나쁜 예시**:
  ```go
  // go.sum이 없어도 go mod download가 자동 생성하므로 go.mod만 필수
  // (처음 보는 사람은 "없어도"가 무슨 의미인지 모름)

  // 기존 golang:1.21을 1.25로 업데이트
  // (과거 상태는 불필요)
  ```

### 언어
- **모든 응답 및 주석**: 한국어
- **코드 변수/함수명**: 영어 (관례)
- **커밋 메시지**: 영어 (관례)

### 이모지 사용
- **원칙**: 절대 사용하지 않음
- **예외**: 사용자가 명시적으로 요청한 경우만

### 코드 일관성 및 재사용성
- **통일성 유지**: 비슷한 목적이나 구조를 가지는 파일을 코딩할 때는 기존 파일과의 통일성을 유지하며 작성
  - 구조체 필드 순서, 주석 스타일, 함수 네이밍 등을 기존 코드와 일치시킴
  - 예: 모델 파일은 비즈니스 필드 먼저, 메타데이터(ID, CreatedAt, UpdatedAt)는 하단에 배치
- **재사용 및 확장 고려**: 기존 코드의 확장 및 재사용 가능성을 고려하고 제안
  - 중복 코드가 발견되면 공통 함수로 추출 제안
  - 유사한 패턴이 반복되면 인터페이스나 제네릭 활용 제안
  - 확장 가능한 설계가 필요하면 사용자에게 먼저 확인

## 프로젝트 관련 결정사항

### 아키텍처
- **패턴**: 임베드형 댓글 시스템 (Disqus 스타일)
- **연동**: codeverse 블로그 (Next.js SSG, localhost:3000)
- **API 포트**: 8080

### 보안
- 최소한의 보안 구성 필요 (추후 구현)
  - CORS 설정
  - Rate Limiting
  - Input Validation
  - Origin 검증
  - 간단한 인증 (이름+비밀번호)

### 디렉토리 구조
```
orbithall/
├── cmd/api/          # 애플리케이션 진입점
├── internal/         # 내부 패키지
│   ├── handlers/
│   ├── models/
│   └── database/
├── .air.toml         # Hot reload 설정
├── docker-compose.yml
├── Dockerfile
└── go.mod
```

## 작업 프로세스

### 작업 관리 방식 (중요!)

이 프로젝트는 **문서 기반 Task-Driven 개발**을 사용합니다.

#### 작업 문서 위치
- `docs/tasks/active/`: 현재 진행 중인 작업
- `docs/tasks/pending/`: 향후 예정된 작업
- `docs/tasks/completed/`: 완료된 작업 (아카이빙)

#### 세션 시작 시 필수 확인사항 (Warmup)
1. `.claude-project-rules.md` 읽기 (이 문서)
2. `docs/tasks/active/` 폴더 확인하여 현재 작업 파악
3. `git status` 확인하여 변경사항 파악
4. 작업 컨텍스트 요약 제공

#### TodoWrite 도구 사용 규칙
- **목적**: 현재 세션의 임시 메모 및 단기 작업 추적용만 사용
- **금지**: 실제 프로젝트 작업은 TodoWrite에 기록하지 않음
- **원칙**: 향후 작업은 반드시 `docs/tasks/pending/`에 마크다운 문서로 생성

#### 작업 문서 생성 규칙
- **새 작업 시작**: `docs/tasks/active/`에 문서 생성
- **작업 완료**: `docs/tasks/completed/`로 이동
- **향후 개선사항 발견**: `docs/tasks/pending/`에 새 문서 생성 (기존 문서 수정 금지)
- **문서 번호**: 연속된 번호 사용 (001, 002, 003...)

#### 작업 문서 작성 원칙
- **목적**: 계획 수립 및 진행 상황 추적 (실행 매뉴얼 아님)
- **간결성**: 핵심만 작성, 장황한 설명 금지
- **코드 최소화**: 코드 예시는 필수 항목만 (SQL 스키마, 환경변수 등)
- **중복 제거**: 이미 코드/README에 있는 내용 반복 금지
- **명확성**: "무엇을" "왜" 하는지 중심으로 작성

#### 작업 문서 포맷
```markdown
# [WIP] 작업 제목

## 작성일
YYYY-MM-DD

## 우선순위
- [x] 높음

## 작업 개요
2-3문장으로 간단히 설명

## 작업 범위
### 포함
- 항목 1
- 항목 2

### 제외
- 항목 1

## 구현 단계
1. 단계 1 (5분)
2. 단계 2 (10분)

## 주요 결정사항
- 결정 1: 이유
- 결정 2: 이유

## 의존성
- 선행: 작업 001
- 후속: 작업 003

## 예상 시간
30분

---

## 작업 이력
### [YYYY-MM-DD] 변경 내용
```

### 새 파일 생성
1. 필요성 확인
2. 사람이 직접 작성하는 파일인지 검증
3. 충분한 주석 포함
4. .gitignore 업데이트 (필요 시)

### 설정 파일 수정
1. 기존 파일 읽기
2. 논리적 오류 검증
3. 주석 추가/수정
4. 변경 사항 설명

### Docker 관련
- `docker-compose up`: 로컬 개발 환경 실행
- 볼륨을 사용해 데이터 영속성 보장
- healthcheck로 의존성 순서 제어

## 금지 사항

1. **자동 생성 파일 직접 작성**
2. **이모지 사용** (명시적 요청 외)
3. **Chi 외 프레임워크 제안** (이미 결정됨)
4. **로컬 설치 제안** (Docker 우선)
5. **불필요한 설명** (간결함 유지)

## 연동 프로젝트 정보

### codeverse (블로그)
- 위치: `/Users/bran/personal/codeverse`
- 프레임워크: Next.js 13.4.4
- 빌드: SSG (Static Site Generation)
- 개발 포트: 3000
- 마크다운 기반 블로그

### 연동 방식
```typescript
// 블로그에서 API 호출 예시
fetch('http://localhost:8080/api/comments?postId=123')
```

## 참고사항

### 사용자 환경
- macOS (Darwin 24.6.0)
- 작업 디렉토리: `/Users/bran/personal/orbithall`
- Docker Desktop 설치됨
- Go 로컬 설치 안 됨 (의도적)
- PostgreSQL 로컬 설치 안 됨 (의도적)

### 개발 경험
- Go 백엔드 경험 거의 없음
- Next.js/TypeScript는 숙련됨
- Docker 사용 가능

## 문서화

### README.md
- 프로젝트 개요
- 기술 스택
- 로컬 개발 가이드
- API 엔드포인트
- 유용한 명령어 모음

### 코드 주석
- 모든 주요 코드 블록에 설명
- Go 초보자도 이해 가능한 수준
- 간결하고 정확한 표현

---

**최종 업데이트**: 2025-10-22
**프로젝트 단계**: 댓글 CRUD API 완료, 프로덕션 배포 완료 (Render + Supabase)
